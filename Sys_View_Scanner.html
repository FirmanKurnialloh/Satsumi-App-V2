<!DOCTYPE html>
<html lang="id">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Satsumi Scanner - Kiosk Mode</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: #020617; color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; }

    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Space+Grotesk:wght@500;700&display=swap');
    
    :root { 
      --bg: #020617; 
      --card: rgba(15, 23, 42, 0.7); 
      --accent: #06b6d4; 
      --primary: #3b82f6; 
      --success: #10b981; 
      --danger: #ef4444; 
      --warning: #f59e0b; 
      --purple: #a855f7; 
      --border: rgba(255, 255, 255, 0.1);
      --glass: rgba(255, 255, 255, 0.03);
      --gold: #facc15;
    }

    #sipgtk-root { 
      all: unset; position: fixed; inset: 0; 
      background: radial-gradient(circle at top right, #0f172a, #020617); 
      color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; 
      display: flex; flex-direction: column; z-index: 99999; overflow: hidden; 
    }
    
    #particle-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
    #confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999998; pointer-events: none; }
    
    header, .ticker-v, main { position: relative; z-index: 1; }
    
    header { 
      height: clamp(60px, 8vh, 80px); padding: 0 clamp(15px, 3vw, 30px); 
      display: flex; justify-content: space-between; align-items: center; 
      border-bottom: 1px solid var(--border); background: rgba(2, 6, 23, 0.7); backdrop-filter: blur(20px); 
    }
    .brand { cursor: pointer; transition: transform 0.2s; display: flex; align-items: center; gap: 10px; }
    .brand:hover { transform: scale(1.02); }
    .brand h1 { font-family: 'Space Grotesk', sans-serif; font-size: clamp(20px, 2.5vw, 28px); font-weight: 800; letter-spacing: 1px; margin: 0; }
    .brand span { color: var(--accent); }
    
    .clock-box { display: flex; align-items: center; gap: 15px; justify-content: flex-end; text-align: right; }
    #sync-badge { display: none; background: var(--warning); color: #020617; padding: 6px 12px; border-radius: 20px; font-weight: 800; font-size: 10px; letter-spacing: 1px; animation: pulseSync 2s infinite; box-shadow: 0 0 15px rgba(245, 158, 11, 0.4); }
    @keyframes pulseSync { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

    #jam-v { font-family: 'Space Grotesk', sans-serif; font-size: clamp(24px, 3vw, 36px); font-weight: 700; color: var(--accent); line-height: 1; }
    #tgl-v { font-size: clamp(9px, 1vw, 11px); font-weight: 700; color: #64748b; text-transform: uppercase; margin-top: 4px; }

    .ticker-v { height: 35px; background: rgba(30, 41, 59, 0.5); display: flex; align-items: center; overflow: hidden; border-bottom: 1px solid var(--border); }
    .ticker-content-v { white-space: nowrap; animation: moveT 150s linear infinite; font-size: 12px; font-weight: 600; color: #94a3b8; padding-left: 100%; }
    @keyframes moveT { from { transform: translateX(0); } to { transform: translateX(-100%); } }

    main { flex: 1; display: grid; grid-template-columns: clamp(300px, 28vw, 380px) 1fr; overflow: hidden; }
    
    .sidebar-v { background: rgba(2, 6, 23, 0.4); border-right: 1px solid var(--border); padding: clamp(15px, 2vw, 25px); display: flex; flex-direction: column; gap: clamp(10px, 1.5vh, 20px); overflow-y: auto; }
    
    .cam-wrapper { position: relative; width: 100%; aspect-ratio: 4/3; border-radius: 16px; overflow: hidden; border: 2px solid #334155; box-shadow: 0 0 25px rgba(0,0,0,0.4); transition: 0.3s; flex-shrink: 0; }
    .cam-wrapper.active { border-color: var(--primary); box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
    .cam-wrapper.inactive { border-color: var(--danger); animation: pulseRed 1.5s infinite; }
    @keyframes pulseRed { 0% { border-color: var(--danger); box-shadow: 0 0 0 rgba(239, 68, 68, 0); } 50% { border-color: #ff0000; box-shadow: 0 0 20px rgba(239, 68, 68, 0.6); } 100% { border-color: var(--danger); box-shadow: 0 0 0 rgba(239, 68, 68, 0); } }
    
    .flash-overlay { position: absolute; inset: 0; background: #fff; opacity: 0; pointer-events: none; z-index: 60; }
    .flash-overlay.do-flash { animation: flashAnim 0.3s ease-out forwards; }
    @keyframes flashAnim { 0% { opacity: 0.8; } 100% { opacity: 0; } }

    video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    .scanner-line { position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: linear-gradient(to right, transparent, var(--accent), transparent); box-shadow: 0 0 10px var(--accent); animation: scanAnim 2.5s ease-in-out infinite; z-index: 5; }
    @keyframes scanAnim { 0%, 100% { top: 0%; } 50% { top: 100%; } }

    .pause-msg { position: absolute; inset: 0; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(5px); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.2s; z-index: 50; cursor: pointer; }
    .cam-wrapper.inactive .pause-msg { opacity: 1; pointer-events: auto; }
    .pause-content { text-align: center; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popUp { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .res-v { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 15px; text-align: center; min-height: 110px; display: flex; flex-direction: column; justify-content: center; backdrop-filter: blur(10px); flex-shrink: 0; }
    
    .stats-v { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; flex-shrink: 0; }
    .st-card { background: var(--glass); border: 1px solid var(--border); border-radius: 12px; padding: 10px 5px; text-align: center; backdrop-filter: blur(5px); transition: transform 0.3s ease; }
    .st-card:hover { transform: scale(1.05); }
    .st-val { font-family: 'Space Grotesk', sans-serif; font-size: clamp(18px, 2vw, 22px); font-weight: 700; margin-bottom: 2px; }
    .st-label { font-size: 9px; font-weight: 800; color: #64748b; letter-spacing: 0.5px; }

    .award-v { background: linear-gradient(135deg, rgba(250, 204, 21, 0.15), rgba(250, 204, 21, 0.02)); border: 1px solid rgba(250, 204, 21, 0.3); border-radius: 16px; padding: 12px; display: none; align-items: center; gap: 12px; margin-top: auto; animation: awardFadeIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); flex-shrink: 0; }
    @keyframes awardFadeIn { from { opacity: 0; transform: scale(0.8) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    .award-img { width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--gold); object-fit: cover; }
    .award-info { flex: 1; overflow: hidden; }
    .award-title { font-size: 9px; font-weight: 800; color: var(--gold); letter-spacing: 1px; margin-bottom: 2px; }
    .award-name { font-size: 12px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .gallery-v { padding: clamp(20px, 3vw, 35px); overflow-y: auto; background: rgba(2, 6, 23, 0.2); scroll-behavior: smooth; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
    .section-header h2 { font-family: 'Space Grotesk', sans-serif; font-weight: 700; font-size: clamp(18px, 2vw, 22px); margin: 0; letter-spacing: -0.5px; }
    
    .grid-v { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: clamp(15px, 2vw, 25px); }
    .card-v { background: var(--card); border-radius: 20px; border: 1px solid var(--border); overflow: hidden; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); backdrop-filter: blur(10px); animation: cardEntrance 0.6s ease-out both; will-change: transform, opacity; }
    @keyframes cardEntrance { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .card-v:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: 0 10px 25px rgba(0,0,0,0.4); }
    
    .card-img-box { width: 100%; aspect-ratio: 4/3; overflow: hidden; background: #1e293b; }
    .card-img-box img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
    .card-v:hover .card-img-box img { transform: scale(1.05); }
    
    .card-body { padding: 15px; }
    .card-name { font-weight: 800; font-size: 14px; margin-bottom: 2px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-role { font-size: 10px; color: #94a3b8; font-weight: 600; margin-bottom: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-meta { display: flex; justify-content: space-between; align-items: flex-end; }
    .card-time { font-family: 'Space Grotesk', sans-serif; font-weight: 700; font-size: 14px; color: #fff; line-height: 1; }
    .card-status-text { font-size: 10px; font-weight: 700; margin-top: 4px; }
    .card-badge { font-size: 9px; font-weight: 800; padding: 5px 10px; border-radius: 8px; text-transform: uppercase; letter-spacing: 0.5px; }

    .overlay-v { position: fixed; inset: 0; background: var(--bg); z-index: 1000000; display: flex; align-items: center; justify-content: center; cursor: pointer; text-align: center; backdrop-filter: blur(15px); transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
    .overlay-v.hide { opacity: 0; transform: scale(1.1); pointer-events: none; }

    .unlock-btn { width: clamp(80px, 15vw, 120px); height: clamp(80px, 15vw, 120px); background: var(--primary); border-radius: 50%; display: grid; place-items: center; font-size: clamp(30px, 6vw, 50px); margin: 0 auto 20px; box-shadow: 0 0 60px rgba(59, 130, 246, 0.5); animation: pulse 2s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); box-shadow: 0 0 80px rgba(59, 130, 246, 0.7); } 100% { transform: scale(1); } }
    
    .cyber-loader { position: relative; width: 45px; height: 45px; margin: 0 auto 8px; }
    .cyber-loader::before, .cyber-loader::after { content: ''; position: absolute; inset: 0; border-radius: 50%; border: 3px solid transparent; }
    .cyber-loader::before { border-top-color: var(--accent); border-bottom-color: var(--primary); animation: spinCyber 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite; }
    .cyber-loader::after { border-left-color: var(--success); border-right-color: var(--accent); animation: spinCyber 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite reverse; transform: scale(0.7); }
    .loading-text { font-weight: 800; color: var(--accent); font-size: 13px; letter-spacing: 3px; text-transform: uppercase; animation: pulseText 1.5s infinite; }
    @keyframes spinCyber { 100% { transform: rotate(360deg); } }
    @keyframes pulseText { 0%, 100% { opacity: 1; text-shadow: 0 0 10px var(--accent); } 50% { opacity: 0.4; text-shadow: none; } }

    .screensaver-v { position: fixed; inset: 0; background: #020617; z-index: 9999999; display: flex; opacity: 1; transition: opacity 0.5s ease; cursor: none; }
    .screensaver-v.hide { opacity: 0; pointer-events: none; }
    
    #saver-content { position: absolute; text-align: center; will-change: transform; display: flex; flex-direction: column; align-items: center; gap: 8px; }
    
    #saver-logo { font-family: 'Space Grotesk', sans-serif; font-size: clamp(40px, 6vw, 70px); font-weight: 800; color: #fff; text-shadow: 0 0 20px rgba(6, 182, 212, 0.6); line-height: 1; }
    #saver-logo span { color: var(--accent); }
    
    .saver-subtitle { font-size: clamp(10px, 1.2vw, 14px); color: #94a3b8; font-family: 'Plus Jakarta Sans', sans-serif; }
    .saver-prompt { margin-top: 15px; padding: 15px 30px; border: 1px solid var(--border); border-radius: 15px; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px); }

    .quote-v { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(2, 6, 23, 0.85); border: 1px solid rgba(6, 182, 212, 0.3); padding: 12px 30px; border-radius: 50px; backdrop-filter: blur(10px); color: #e2e8f0; font-size: clamp(10px, 1.2vw, 12px); font-weight: 600; z-index: 100; box-shadow: 0 5px 25px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 12px; animation: floatQuote 4s ease-in-out infinite; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: none; white-space: nowrap; max-width: 90vw; }
    .quote-v.hidden { opacity: 0; transform: translate(-50%, 20px) scale(0.9); }
    .quote-v span { font-size: 16px; animation: pulseSync 2s infinite; }
    #quote-text { transition: opacity 0.5s ease; font-style: italic; overflow: hidden; text-overflow: ellipsis; }
    @keyframes floatQuote { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -8px); } }
    
    #toast-container { position: fixed; bottom: 20px; right: clamp(15px, 3vw, 30px); z-index: 999999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast-v { background: rgba(15, 23, 42, 0.95); border-left: 4px solid var(--accent); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); backdrop-filter: blur(10px); color: #fff; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 10px; animation: slideInToast 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    .toast-v.hide { animation: slideOutToast 0.4s ease forwards; }
    @keyframes slideInToast { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOutToast { to { transform: translateX(120%); opacity: 0; } }

    /* ===== OVERLAY GAMIFIKASI ===== */
    .gami-overlay { position: fixed; inset: 0; z-index: 9999995; background: rgba(2, 6, 23, 0.85); backdrop-filter: blur(15px); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.4s ease; }
    .gami-overlay.show { opacity: 1; }
    .gami-card { background: linear-gradient(145deg, rgba(15, 23, 42, 0.9), rgba(2, 6, 23, 0.95)); border: 2px solid var(--gold); padding: 40px; border-radius: 30px; text-align: center; box-shadow: 0 0 50px rgba(250, 204, 21, 0.3), inset 0 0 20px rgba(250, 204, 21, 0.1); transform: scale(0.5); transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .gami-overlay.show .gami-card { transform: scale(1); }
    .gami-img { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--gold); object-fit: cover; box-shadow: 0 0 20px rgba(250, 204, 21, 0.5); margin-bottom: 20px; }
    .gami-title { font-family: 'Space Grotesk', sans-serif; color: var(--gold); font-size: 28px; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; margin: 0 0 5px 0; text-shadow: 0 2px 10px rgba(250, 204, 21, 0.4); }
    .gami-name { font-size: 22px; font-weight: 700; color: #fff; margin: 0; }
    .gami-sub { font-size: 14px; color: #94a3b8; font-weight: 500; margin-top: 10px; }
    /* ============================== */

    #scanner-input {
      display: block; width: 100%; font-size: 1.3rem; padding: 14px 18px; border-radius: 10px;
      border: 2px solid var(--accent); margin: 18px 0 0 0; background: #fff; color: #020617;
      font-weight: 700; letter-spacing: 2px; box-sizing: border-box; outline: none;
    }
    #scanner-input:focus { box-shadow: 0 0 0 2px var(--primary); }
    
    @media (max-width: 900px) {
      main { display: block; overflow-y: auto; -webkit-overflow-scrolling: touch; }
      .sidebar-v { border-right: none; border-bottom: 1px solid var(--border); height: auto; max-height: none; overflow-y: visible; padding-bottom: 30px; }
      .cam-wrapper { max-width: 100%; margin: 0 auto; }
      .gallery-v { overflow-y: visible; height: auto; padding-bottom: 40px; }
      .award-v { margin-top: 20px; }
      header { height: auto; padding: 12px 15px; }
    }
    @media (max-width: 480px) {
      header { flex-direction: column; text-align: center; gap: 8px; padding: 15px; }
      .clock-box { text-align: center; justify-content: center; flex-direction: column-reverse; }
      .stats-v { grid-template-columns: repeat(2, 1fr); }
      .section-header { flex-direction: column; align-items: flex-start; gap: 15px; }
    }
  </style>
</head>
<body>

<audio id="silent-audio" loop>
  <source src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTSVMAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//oeAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAw//oeAAAAAAAAAAAAAAAAAAAAAAAATGF2YzU4LjU0AAAAAAAAAAAAAAAAAAAAAAAAAAAACCAAAAAAAAAAAAAA//4QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//4QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" type="audio/mpeg">
</audio>

<div id="sipgtk-root">
  
  <canvas id="particle-canvas"></canvas>
  <canvas id="confetti-canvas"></canvas>

  <div id="screensaver" class="screensaver-v hide">
    <div id="saver-content">
      <div id="saver-logo">SIPGTK<span>.PRO</span></div>
      <div class="saver-subtitle">
        Sistem Informasi Presensi Guru dan Tenaga Kependidikan<br>
        <span id="saver-school-name" style="font-weight: 800; color: #fff;">...</span>
      </div>
      <div class="saver-prompt">
        <div style="font-weight:800; font-size:clamp(14px, 1.5vw, 16px); letter-spacing:1px; color: var(--accent); animation: pulse 2s infinite;">SISTEM SIAP MEMINDAI</div>
        <div style="font-size: 10px; font-weight: 600; color: #94a3b8; margin-top: 5px;">Tunjukan Kartu QR ke mesin</div>
      </div>
    </div>
  </div>
  <div id="unlock-v" class="overlay-v">
    <div>
      <div class="unlock-btn">üîò</div>
      <h2 style="font-weight:800; letter-spacing:2px; font-size: clamp(18px, 4vw, 24px);">INITIALIZE SCANNER</h2>
      <p style="color:#64748b; font-weight:700; text-transform: uppercase; font-size: clamp(10px, 2vw, 12px); letter-spacing: 1px;">
        Klik untuk mengaktifkan<br>
        <span style="font-size: clamp(10px, 1.2vw, 12px); display:block; color:#94a3b8; font-family:'Plus Jakarta Sans'; margin-top:8px; line-height: 1.5;">
          Sistem Informasi Presensi Guru dan Tenaga Kependidikan<br>
          <span id="unlock-school-name" style="color:var(--accent); font-weight:800; font-size: clamp(12px, 1.5vw, 14px);">Memuat data instansi...</span>
        </span>
      </p>
    </div>
  </div>
  <header>
    <div class="brand" onclick="login()"><h1>SIPGTK<span>.PRO</span></h1></div>
    <div class="clock-box">
      <div id="sync-badge">üîÑ 0 PENDING</div>
      <div>
        <div id="jam-v">00:00:00</div>
        <div id="tgl-v">...</div>
      </div>
    </div>
  </header>

  <div class="ticker-v"><div class="ticker-content-v" id="ticker-text-v">Sistem Terkoneksi. Menunggu aktivitas pemindaian untuk hari ini...</div></div>

  <main>
    <aside class="sidebar-v">
      <div class="cam-wrapper active" id="cam-box-v">
        <div class="scanner-line"></div>
        <div id="flash-v" class="flash-overlay"></div>
        <video id="video-v" autoplay muted playsinline></video>
        <canvas id="canvas-v" width="320" height="240" style="display:none"></canvas>
        <div class="pause-msg" onclick="refocusInput()">
          <div class="pause-content">
            <div style="font-size:35px">üö´</div>
            <div style="font-size:16px; font-weight:800; color:#ef4444; margin-top:5px; letter-spacing:1px">SCANNER OFF</div>
            <div style="font-size:10px; color:#94a3b8; margin-top:5px">Klik di sini untuk aktifkan kembali</div>
          </div>
        </div>
      </div>
      
      <div id="res-box-v" class="res-v">
        <div style="font-size:30px; margin-bottom: 5px;">üì°</div>
        <div style="font-weight:800; font-size:clamp(14px, 1.5vw, 16px); letter-spacing:1px; color: var(--accent);">SISTEM SIAP MEMINDAI<br><span style="font-size: 10px; font-weight: 600; color: #94a3b8;">Tunjukan Kartu QR ke mesin</span></div>
        <div id="mode-v" style="margin-top:8px; padding:5px 12px; border-radius:15px; font-size:9px; font-weight:800; letter-spacing:1.5px; text-transform:uppercase; display:inline-block; background:#1e293b; color:#fff;">‚Äî</div>
      </div>
      
      <div class="stats-v">
        <div class="st-card"><div id="s-masuk" class="st-val" style="color:var(--success)">0</div><div class="st-label">MASUK</div></div>
        <div class="st-card"><div id="s-izin" class="st-val" style="color:var(--accent)">0</div><div class="st-label">IZIN</div></div>
        <div class="st-card"><div id="s-sakit" class="st-val" style="color:var(--danger)">0</div><div class="st-label">SAKIT</div></div>
        <div class="st-card"><div id="s-pulang" class="st-val" style="color:var(--warning)">0</div><div class="st-label">PULANG</div></div>
        <div class="st-card" style="grid-column: span 2;"><div id="s-lembur" class="st-val" style="color:var(--purple)">0</div><div class="st-label">LEMBUR</div></div>
      </div>
  
      <div id="award-v" class="award-v">
        <img id="award-img" src="" class="award-img">
        <div class="award-info">
          <div class="award-title">üèÜ EARLY BIRD</div>
          <div id="award-name" class="award-name">-</div>
        </div>
      </div>

      <input type="text" id="scanner-input" autocomplete="off" autofocus>
    </aside>
    <section class="gallery-v">
      <div class="section-header">
        <h2>Aktivitas Hari Ini</h2>
        <span id="total-count-v" style="background:var(--primary); padding:8px 18px; border-radius:50px; font-size:10px; font-weight:800; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);">0 REKAMAN</span>
      </div>
      <div id="list-v" class="grid-v"></div>
    </section>
  </main>
  
  <div id="toast-container"></div>
  <div class="quote-v" id="quote-box-v">
    <span>üí°</span>
    <div id="quote-text">"Seorang guru menggandeng tangan, membuka pikiran, dan menyentuh hati."</div>
  </div>

  <div id="gamification-v" class="gami-overlay">
    <div class="gami-card">
      <img id="gami-img" src="" class="gami-img">
      <h2 id="gami-title" class="gami-title">üèÜ EARLY BIRD</h2>
      <p id="gami-name" class="gami-name">Nama Guru</p>
      <p id="gami-sub" class="gami-sub">Apresiasi untuk semangat hari ini!</p>
    </div>
  </div>
</div>

<script>
  function showToast(msg, type) {
    var container = document.getElementById("toast-container");
    var toast = document.createElement("div");
    toast.className = "toast-v";
    
    var color = type === 'success' ? 'var(--success)' : (type === 'error' ? 'var(--danger)' : (type === 'warning' ? 'var(--warning)' : 'var(--accent)'));
    var icon = type === 'success' ? '‚úÖ' : (type === 'error' ? '‚ùå' : (type === 'warning' ? '‚ö†Ô∏è' : 'üîÑ'));
    
    toast.style.borderLeftColor = color;
    toast.innerHTML = "<span style='font-size:16px'>" + icon + "</span> <span>" + msg + "</span>";
    container.appendChild(toast);
    
    setTimeout(function() {
      toast.classList.add("hide");
      setTimeout(function() { toast.remove(); }, 400);
    }, 4000); 
  }

  var quotesArray = [
    "Seorang guru menggandeng tangan, membuka pikiran, dan menyentuh hati.",
    "Pendidikan adalah senjata paling mematikan di dunia.",
    "Guru yang baik itu seperti lilin, menghabiskan dirinya untuk menerangi jalan orang lain.",
    "Mengajar adalah belajar dua kali.",
    "Tugas pendidik bukanlah menebang hutan, tetapi mengairi gurun.",
    "Hanya pendidikan yang bisa menyelamatkan masa depan.",
    "Satu buku, satu pena, satu anak, dan satu guru dapat mengubah dunia.",
    "Guru hebat bisa menginspirasi harapan dan memantik imajinasi."
  ];
  var quoteIndex = 0;
  
  setInterval(function() {
    var qText = document.getElementById("quote-text");
    if(qText && !isProcessing) {
      qText.style.opacity = 0;
      setTimeout(function() {
        quoteIndex = (quoteIndex + 1) % quotesArray.length;
        qText.innerText = '"' + quotesArray[quoteIndex] + '"';
        qText.style.opacity = 1;
      }, 500);
    }
  }, 15000); 

  var pCanvas = document.getElementById("particle-canvas");
  var pCtx = pCanvas.getContext("2d");
  var particlesArray = [];
  var pWidth, pHeight;

  function resizeCanvas() {
    pWidth = pCanvas.width = window.innerWidth;
    pHeight = pCanvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  function ParticleObj() {
    this.x = Math.random() * pWidth;
    this.y = Math.random() * pHeight;
    this.vx = (Math.random() - 0.5) * 0.5;
    this.vy = (Math.random() - 0.5) * 0.5;
    this.radius = Math.random() * 1.5 + 0.5;
  }

  ParticleObj.prototype.update = function() {
    this.x += this.vx;
    this.y += this.vy;
    if (this.x < 0 || this.x > pWidth) this.vx *= -1;
    if (this.y < 0 || this.y > pHeight) this.vy *= -1;
  };

  ParticleObj.prototype.draw = function() {
    pCtx.beginPath();
    pCtx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    pCtx.fillStyle = "rgba(6, 182, 212, 0.5)"; 
    pCtx.fill();
  };

  for (var i = 0; i < 70; i++) {
    particlesArray.push(new ParticleObj());
  }

  function animateParticles() {
    pCtx.clearRect(0, 0, pWidth, pHeight);
    for (var i = 0; i < particlesArray.length; i++) {
      particlesArray[i].update();
      particlesArray[i].draw();
      for (var j = i + 1; j < particlesArray.length; j++) {
        var dx = particlesArray[i].x - particlesArray[j].x;
        var dy = particlesArray[i].y - particlesArray[j].y;
        var dist = Math.sqrt(dx * dx + dy * dy);
        
        if (dist < 120) {
          pCtx.beginPath();
          pCtx.moveTo(particlesArray[i].x, particlesArray[i].y);
          pCtx.lineTo(particlesArray[j].x, particlesArray[j].y);
          var opacity = (1 - dist / 120) * 0.3;
          pCtx.strokeStyle = "rgba(6, 182, 212, " + opacity + ")";
          pCtx.lineWidth = 1;
          pCtx.stroke();
        }
      }
    }
    requestAnimationFrame(animateParticles);
  }
  animateParticles();

  // ===== CONFETTI ENGINE =====
  var cCanvas = document.getElementById("confetti-canvas");
  var cCtx = cCanvas.getContext("2d");
  var confettis = [];
  var confettiColors = ['#10b981', '#3b82f6', '#facc15', '#ef4444', '#a855f7'];
  var isConfettiActive = false;

  function resizeConfettiCanvas() {
    cCanvas.width = window.innerWidth;
    cCanvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resizeConfettiCanvas);
  resizeConfettiCanvas();

  function fireConfetti() {
    confettis = [];
    isConfettiActive = true;
    for (var i = 0; i < 150; i++) {
      confettis.push({
        x: Math.random() * cCanvas.width,
        y: Math.random() * -cCanvas.height, // Mulai dari atas luar layar
        w: Math.random() * 10 + 5,
        h: Math.random() * 10 + 5,
        color: confettiColors[Math.floor(Math.random() * confettiColors.length)],
        vx: (Math.random() - 0.5) * 6,
        vy: Math.random() * 5 + 3,
        rot: Math.random() * 360,
        rotSpeed: (Math.random() - 0.5) * 10
      });
    }
    animateConfetti();
  }

  function animateConfetti() {
    if (!isConfettiActive) return;
    cCtx.clearRect(0, 0, cCanvas.width, cCanvas.height);
    var activeCount = 0;
    
    for (var i = 0; i < confettis.length; i++) {
      var p = confettis[i];
      p.y += p.vy;
      p.x += p.vx;
      p.rot += p.rotSpeed;
      
      if (p.y < cCanvas.height) { activeCount++; }
      
      cCtx.save();
      cCtx.translate(p.x + p.w / 2, p.y + p.h / 2);
      cCtx.rotate(p.rot * Math.PI / 180);
      cCtx.fillStyle = p.color;
      cCtx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
      cCtx.restore();
    }
    
    if (activeCount > 0) { requestAnimationFrame(animateConfetti); } 
    else { isConfettiActive = false; cCtx.clearRect(0, 0, cCanvas.width, cCanvas.height); }
  }

  function triggerGamification(title, name, imgUrl, subtitle) {
    var overlay = document.getElementById("gamification-v");
    document.getElementById("gami-title").innerText = title;
    document.getElementById("gami-name").innerText = name;
    document.getElementById("gami-sub").innerText = subtitle || "Luar Biasa!";
    
    var imgEl = document.getElementById("gami-img");
    imgEl.src = (imgUrl && imgUrl.length > 50) ? imgUrl : "https://ui-avatars.com/api/?name=" + name.charAt(0) + "&background=random&color=fff";
    
    overlay.classList.add("show");
    fireConfetti();
    playSFX('fanfare');

    setTimeout(function() {
      overlay.classList.remove("show");
    }, 6000); // Overlay hilang dalam 6 detik
  }
  // ===========================

  var normalTickerText = "Sistem Terkoneksi. Menunggu aktivitas pemindaian untuk hari ini...";
  var windowDataSignature = ""; 
  var lastScanCode = "";
  var lastScanTime = 0;
  var wakeLock = null;
  var currentDay = new Date().getDate(); 
  var isProcessing = false;
  
  var defaultStatusHTML = "<div style='font-size:30px; margin-bottom: 5px;'>üì°</div>" +
      "<div style='font-weight:800; font-size:clamp(14px, 1.5vw, 16px); letter-spacing:1px; color: var(--accent);'>SISTEM SIAP MEMINDAI<br><span style='font-size: 10px; font-weight: 600; color: #94a3b8;'>Tunjukan Kartu QR ke mesin</span></div>" +
      "<div id='mode-v' style='margin-top:8px; padding:5px 12px; border-radius:15px; font-size:9px; font-weight:800; letter-spacing:1.5px; text-transform:uppercase; display:inline-block; background:#1e293b; color:#fff;'>‚Äî</div>";

  var isBackgroundSyncing = false;

  function updateSyncBadge() {
    var pendingList = JSON.parse(localStorage.getItem('sipgtk_pending') || '[]');
    var badge = document.getElementById('sync-badge');
    var ticker = document.getElementById("ticker-text-v");

    if (pendingList.length > 0) {
      badge.style.display = 'block';
      badge.innerText = "üîÑ " + pendingList.length + " PENDING";
    } else {
      badge.style.display = 'none';
    }

    if (!navigator.onLine) {
      badge.style.background = "var(--danger)";
      badge.style.color = "#fff";
      badge.innerText = "‚ö†Ô∏è OFFLINE (" + pendingList.length + ")";
      if (ticker) ticker.innerText = "‚ö†Ô∏è KONEKSI TERPUTUS - BERJALAN DALAM MODE OFFLINE. SILAKAN LANJUTKAN PRESENSI. DATA AKAN DISIMPAN OTOMATIS. ‚Ä¢ ".repeat(3);
    } else {
      badge.style.background = "var(--warning)";
      badge.style.color = "#020617";
      if (ticker) ticker.innerText = (normalTickerText + " ‚Ä¢ ").repeat(5);
    }
  }

  window.addEventListener('online', updateSyncBadge);
  window.addEventListener('offline', updateSyncBadge);

  function handleOfflineSave(nik, photo) {
    isProcessing = false;
    document.getElementById("quote-box-v").classList.remove("hidden"); 
    playSFX('success'); 
    
    var pendingScans = JSON.parse(localStorage.getItem('sipgtk_pending') || '[]');
    pendingScans.push({ nik: nik, photo: photo, time: Date.now() });
    localStorage.setItem('sipgtk_pending', JSON.stringify(pendingScans));
    
    updateSyncBadge();
    showToast("Koneksi gagal! Data Anda disimpan secara offline.", "warning"); 

    var rb = document.getElementById("res-box-v");
    rb.innerHTML = "<div style='color:var(--warning); font-size:14px; font-weight:800; padding: 10px;'>‚ö† Tersimpan Offline<br><span style='font-size:10px; color:#fff; font-weight:500;'>Akan otomatis dikirim saat jaringan stabil</span></div>";
    
    speak("Data tersimpan offline.");
    setTimeout(function() { rb.innerHTML = defaultStatusHTML; }, 3000);
  }

  function startBackgroundSync() {
    setInterval(function() {
      if (!navigator.onLine || isBackgroundSyncing) return;
      
      var pendingScans = JSON.parse(localStorage.getItem('sipgtk_pending') || '[]');
      if (pendingScans.length === 0) return;

      isBackgroundSyncing = true;
      var dataToSync = pendingScans[0]; 

      google.script.run
        .withSuccessHandler(function(res) {
          var updatedScans = JSON.parse(localStorage.getItem('sipgtk_pending') || '[]');
          updatedScans.shift(); 
          localStorage.setItem('sipgtk_pending', JSON.stringify(updatedScans));
          
          isBackgroundSyncing = false;
          updateSyncBadge();
          showToast("1 Data Offline berhasil dikirim ke server!", "success"); 
          window.refreshUI(); 
        })
        .withFailureHandler(function(err) {
          isBackgroundSyncing = false;
        })
        .simpanPresensi(dataToSync.nik, dataToSync.photo); 
        
    }, 10000); 
  }

  var audioCtx;
  function initAudio() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') {
      audioCtx.resume();
    }
  }

  function playSFX(type) {
    if (!audioCtx) return;
    
    var oscillator = audioCtx.createOscillator();
    var gainNode = audioCtx.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    
    var now = audioCtx.currentTime;
    
    if (type === 'processing') {
      oscillator.type = 'square';
      oscillator.frequency.setValueAtTime(2000, now);
      oscillator.frequency.exponentialRampToValueAtTime(4000, now + 0.1);
      gainNode.gain.setValueAtTime(0.05, now);
      gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
      oscillator.start(now);
      oscillator.stop(now + 0.1);

    } else if (type === 'success') {
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(600, now);
      oscillator.frequency.setValueAtTime(900, now + 0.1);
      gainNode.gain.setValueAtTime(0.3, now);
      gainNode.gain.setValueAtTime(0.3, now + 0.1);
      gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
      oscillator.start(now);
      oscillator.stop(now + 0.4);

    } else if (type === 'error') {
      oscillator.type = 'sawtooth';
      oscillator.frequency.setValueAtTime(150, now);
      gainNode.gain.setValueAtTime(0.3, now);
      gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
      oscillator.start(now);
      oscillator.stop(now + 0.4);

    } else if (type === 'startup') {
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(300, now);
      oscillator.frequency.exponentialRampToValueAtTime(1200, now + 0.5);
      gainNode.gain.setValueAtTime(0, now);
      gainNode.gain.linearRampToValueAtTime(0.2, now + 0.2);
      gainNode.gain.linearRampToValueAtTime(0, now + 0.5);
      oscillator.start(now);
      oscillator.stop(now + 0.5);

    } else if (type === 'shutter') {
      oscillator.type = 'triangle';
      oscillator.frequency.setValueAtTime(2000, now);
      oscillator.frequency.exponentialRampToValueAtTime(500, now + 0.05);
      gainNode.gain.setValueAtTime(0.8, now);
      gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
      oscillator.start(now);
      oscillator.stop(now + 0.1);

    } else if (type === 'fanfare') {
      var freqs = [261.63, 329.63, 392.00, 523.25];
      var startTime = now;
      for (var i = 0; i < freqs.length; i++) {
        var osc = audioCtx.createOscillator();
        var gn = audioCtx.createGain();
        osc.connect(gn);
        gn.connect(audioCtx.destination);
        osc.type = 'square';
        osc.frequency.value = freqs[i];
        
        var d = (i === freqs.length - 1) ? 0.6 : 0.15; 
        gn.gain.setValueAtTime(0.2, startTime);
        gn.gain.exponentialRampToValueAtTime(0.01, startTime + d);
        
        osc.start(startTime);
        osc.stop(startTime + d);
        startTime += 0.15;
      }
    }
  }

  var idleTime = 0;
  var isScreensaverActive = false;
  var saverElem, saverContent;
  var posX = 0, posY = 0, dirX = 1, dirY = 1, speed = 2; 
  var IDLE_TIMEOUT_SECONDS = 120; 

  function resetIdleTimer() {
    idleTime = 0;
    if (isScreensaverActive) {
      isScreensaverActive = false;
      saverElem.classList.add("hide");
      document.getElementById("scanner-input").focus(); 
    }
  }

  window.addEventListener('mousemove', resetIdleTimer);
  window.addEventListener('keydown', resetIdleTimer);
  window.addEventListener('touchstart', resetIdleTimer);
  window.addEventListener('click', resetIdleTimer);

  function startIdleTimer() {
    saverElem = document.getElementById("screensaver");
    saverContent = document.getElementById("saver-content"); 
    
    setInterval(function() {
      idleTime++;
      if (idleTime >= IDLE_TIMEOUT_SECONDS && !isScreensaverActive) {
        isScreensaverActive = true;
        saverElem.classList.remove("hide");
      }
    }, 1000);

    requestAnimationFrame(animateScreensaver);
  }

  function animateScreensaver() {
    if (isScreensaverActive && saverContent) {
      var rect = saverElem.getBoundingClientRect();
      var contentRect = saverContent.getBoundingClientRect();
      
      posX += speed * dirX;
      posY += speed * dirY;
      
      if (posX <= 0 || posX + contentRect.width >= rect.width) dirX *= -1;
      if (posY <= 0 || posY + contentRect.height >= rect.height) dirY *= -1;
      
      posX = Math.max(0, Math.min(posX, rect.width - contentRect.width));
      posY = Math.max(0, Math.min(posY, rect.height - contentRect.height));

      saverContent.style.transform = "translate(" + posX + "px, " + posY + "px)";
    }
    requestAnimationFrame(animateScreensaver);
  }

  function openFullscreen() {
    var elem = document.documentElement;
    if (elem.requestFullscreen) {
      elem.requestFullscreen().catch(function(err) { console.log(err); });
    } else if (elem.webkitRequestFullscreen) { 
      elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) { 
      elem.msRequestFullscreen();
    }
  }

  document.getElementById("unlock-v").addEventListener("click", function() {
    openFullscreen();
    initAudio(); 
    playSFX('startup'); 
    window.initSystem();
  });

  document.getElementById("award-img").addEventListener("error", function() {
    this.src = "https://ui-avatars.com/api/?background=random&color=fff";
  });

  async function activateKeepAlive() {
    try {
      document.getElementById("silent-audio").play().catch(function(e) { console.log("Audio play failed"); });
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');
      }
    } catch (err) { console.log(err); }
  }

  document.addEventListener("visibilitychange", async function() {
    if (wakeLock !== null && document.visibilityState === "visible") {
      if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen');
    }
  });

  window.initSystem = function() {
    var unlockScreen = document.getElementById("unlock-v");
    unlockScreen.classList.add("hide"); 
    
    setTimeout(function() {
      unlockScreen.style.display = "none";
      showToast("Sistem Scanner berhasil diaktifkan!", "info"); 
    }, 600);

    var inp = document.getElementById("scanner-input");
    var video = document.getElementById("video-v");
    
    activateKeepAlive();
    updateSyncBadge(); 
    startBackgroundSync(); 

    if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
      navigator.mediaDevices.getUserMedia({video:{width:320, height:240}}).then(function(s) { video.srcObject = s; }).catch(function(err) { alert("Gagal mengakses kamera."); });
    }
    
    inp.focus();
    checkFocus();

    setInterval(function() { if(!document.hidden) inp.focus(); }, 1500);
    document.body.addEventListener("click", function() { inp.focus(); activateKeepAlive(); });
    
    window.startCore();
  };

  var inputTrap = document.getElementById("scanner-input");
  var camBox = document.getElementById("cam-box-v");

  function checkFocus() {
    if(document.activeElement === inputTrap) { 
      camBox.classList.add("active"); camBox.classList.remove("inactive"); 
    } else { 
      camBox.classList.add("inactive"); camBox.classList.remove("active"); 
    }
  }

  inputTrap.addEventListener("blur", function() {
    checkFocus();
    setTimeout(function() { checkFocus(); }, 100);
  });
  inputTrap.addEventListener("focus", function() { checkFocus(); });
  window.refocusInput = function() { inputTrap.focus(); checkFocus(); };

  function speak(txt) {
    if (window.speechSynthesis) {
      window.speechSynthesis.cancel();
      var msg = new SpeechSynthesisUtterance(txt);
      msg.lang = "id-ID";
      window.speechSynthesis.speak(msg);
    }
  }

  function getSapaanWaktu() {
    var hour = new Date().getHours();
    if (hour >= 4 && hour < 11) return "pagi";
    if (hour >= 11 && hour < 15) return "siang";
    if (hour >= 15 && hour < 18) return "sore";
    return "malam";
  }

  function generateUcapanNatural(nama, mode, keterangan, status) {
    var waktu = getSapaanWaktu();
    var namaPanggilan = nama ? nama.split(" ")[0] : "Bapak Ibu";
    
    if (status === 'duplikat') {
      var tplDup = [
        "Halo " + namaPanggilan + ", kamu sudah absen ya.",
        "Sistem mencatat kamu sudah presensi sebelumnya, " + namaPanggilan + ".",
        "Sip! " + namaPanggilan + " kamu sudah absen."
      ];
      return tplDup[Math.floor(Math.random() * tplDup.length)];
    }

    if (status !== 'success') return "Maaf, data tidak ditemukan dalam sistem.";

    mode = (mode || "").toLowerCase();
    keterangan = (keterangan || "").toLowerCase();

    if (mode.includes('masuk')) {
      if (keterangan.includes('terlambat')) {
        var tplInLate = [
          "Selamat " + waktu + " " + namaPanggilan + ". Kamu tercatat terlambat hari ini.",
          "Halo " + namaPanggilan + ". Mohon perhatikan waktu kehadiran besok ya.",
          "Selamat " + waktu + " " + namaPanggilan + ". Besok usahakan datang lebih awal ya."
        ];
        return tplInLate[Math.floor(Math.random() * tplInLate.length)];
      } else {
        var tplIn = [
          "Selamat " + waktu + " " + namaPanggilan + ", selamat beraktivitas!",
          "Halo " + namaPanggilan + ", semangat untuk hari ini ya!",
          "Terima kasih " + namaPanggilan + ", semoga harimu menyenangkan hari ini."
        ];
        return tplIn[Math.floor(Math.random() * tplIn.length)];
      }
    } else if (mode.includes('pulang')) {
      if (keterangan.includes('cepat') || keterangan.includes('awal')) {
        var tplOutEarly = [
          "Halo " + namaPanggilan + ", kamu tercatat pulang lebih awal.",
          "Hati-hati " + namaPanggilan + ", pastikan sudah konfirmasi izin ya.",
          namaPanggilan + ", kamu pulang lebih cepat hari ini. Hati-hati di jalan."
        ];
        return tplOutEarly[Math.floor(Math.random() * tplOutEarly.length)];
      } else {
        var tplOut = [
          "Terima kasih " + namaPanggilan + ", hati-hati di jalan pulang.",
          "Kerja bagus hari ini " + namaPanggilan + ", selamat beristirahat.",
          "Sampai jumpa besok " + namaPanggilan + ", hati-hati di jalan."
        ];
        return tplOut[Math.floor(Math.random() * tplOut.length)];
      }
    } else if (mode.includes('lembur')) {
      var tplLembur = [
        "Semangat lembur " + namaPanggilan + ", jangan lupa jaga kesehatan ya.",
        "Terima kasih atas dedikasinya " + namaPanggilan + ".",
        "Kerja keras yang luar biasa " + namaPanggilan + ", semangat lembur!"
      ];
      return tplLembur[Math.floor(Math.random() * tplLembur.length)];
    }

    return "Presensi berhasil, " + namaPanggilan + ".";
  }

  // ===== MENGAMBIL NAMA INSTANSI UNTUK LAYAR UNLOCK =====
  google.script.run.withSuccessHandler(function(res) {
    if(res && res.nama) {
      var unlockName = document.getElementById("unlock-school-name");
      if(unlockName) unlockName.innerText = res.nama;
    }
  }).withFailureHandler(function(err){ 
    console.log("Gagal memuat nama instansi karena offline."); 
  }).getPresensiScannerSettings();
  // ========================================================

  window.login = function() {
    google.script.run.withSuccessHandler(function(url) {
      window.open(url + "?page=login", "_blank"); 
    }).getScriptUrl();
  };

  window.startCore = function() {
    startIdleTimer(); 

    setInterval(function() {
      var d = new Date();
      document.getElementById("jam-v").innerText = d.toLocaleTimeString("id-ID", {hour12:false});
      document.getElementById("tgl-v").innerText = d.toLocaleDateString("id-ID", {weekday:'long', day:'numeric', month:'long', year:'numeric'});
      
      if (d.getDate() !== currentDay) { window.location.reload(); }
    }, 1000);

    google.script.run
      .withSuccessHandler(function(res) {
        if(res && res.info) {
          normalTickerText = res.info; 
          if (navigator.onLine) {
            document.getElementById("ticker-text-v").innerText = (normalTickerText + " ‚Ä¢ ").repeat(5);
          }
        }
        if(res && res.nama) {
          var brand = document.querySelector(".brand h1");
          if(brand) brand.innerHTML = "SIPGTK <span style='font-size: clamp(10px, 1.2vw, 12px); display:block; color:#64748b; font-family:\"Plus Jakarta Sans\"'>Sistem Informasi Presensi <span>" + res.nama + "</span></span>";
          
          var saverSchoolName = document.getElementById("saver-school-name");
          if (saverSchoolName) saverSchoolName.innerText = res.nama;
        }
      })
      .withFailureHandler(function(err){ /* Supress error saat offline */ })
      .getPresensiScannerSettings();

    setInterval(function() {
      google.script.run
        .withSuccessHandler(function(res) {
          if(res && res.mode){
            var m = document.getElementById("mode-v");
            // ===== FIX ERROR NULL INNERTEXT DI SINI =====
            if (m) { 
              m.innerText = res.mode;
              if(res.mode.includes("MASUK"))      m.style.background = "#10b981";
              else if(res.mode.includes("PULANG"))m.style.background = "#f59e0b";
              else if(res.mode.includes("LEMBUR"))m.style.background = "#a855f7";
              else if(res.mode.includes("TERLAMBAT")) m.style.background = "#ef4444";
              else if(res.mode.includes("HADIR")) m.style.background = "#06b6d4";
              else m.style.background = "#334155";
            }
            // ============================================
          }
        })
        .withFailureHandler(function(err){ /* Supress error saat offline */ })
        .getCurrentSessionMode();
    }, 5000);

    document.getElementById("scanner-input").addEventListener("keydown", function(e) {
      if(e.key === "Enter") {
        var val = e.target.value.trim();
        e.target.value = "";
        resetIdleTimer(); 
        if(val.length > 3) window.executeScan(val);
      }
    });

    window.refreshUI(); 
    setInterval(function() { window.refreshUI(); }, 5000);
  };

  window.executeScan = function(nik) {
    var now = Date.now();
    if(nik === lastScanCode && (now - lastScanTime < 3000)) return; 
    lastScanCode = nik;
    lastScanTime = now;

    if(isProcessing) return;
    isProcessing = true;
    
    document.getElementById("quote-box-v").classList.add("hidden");
    
    playSFX('shutter');
    var flashEl = document.getElementById("flash-v");
    flashEl.classList.remove("do-flash"); 
    void flashEl.offsetWidth; 
    flashEl.classList.add("do-flash");

    playSFX('processing');

    var rb = document.getElementById("res-box-v");
    rb.innerHTML = "<div style='display:flex; flex-direction:column; justify-content:center; align-items:center; height:100%;'>" +
                   "<div class='cyber-loader'></div>" +
                   "<div class='loading-text'>MEMVERIFIKASI...</div>" +
                   "</div>";
    
    var cvs = document.getElementById("canvas-v");
    var video = document.getElementById("video-v");
    var ctx = cvs.getContext("2d");
    ctx.drawImage(video, 0, 0, 320, 240);
    var photo = cvs.toDataURL("image/jpeg", 0.4);

    if (!navigator.onLine) {
      handleOfflineSave(nik, photo);
      return;
    }

    google.script.run
      .withSuccessHandler(function(res) {
        isProcessing = false;
        var ucapan = "";

        if (res && res.status === 'success') {
          
          // ============================================================
          // ‚ö†Ô∏è KODE BYPASS TESTING (Hapus nanti jika server sudah siap) ‚ö†Ô∏è
          // Kode ini memaksa Kiosk mengira absen PERTAMA adalah Early Bird
          if (window.gamiTested === undefined) {
             res.is_early_bird = true; 
             window.gamiTested = true;
          }
          // ============================================================

          if (res.is_birthday) {
            triggerGamification("üéÇ SELAMAT ULANG TAHUN!", res.nama, res.foto, "Semoga panjang umur dan sehat selalu!");
            speak("Selamat ulang tahun, " + res.nama.split(" ")[0] + ". Semoga harimu menyenangkan!");
          } else if (res.is_early_bird) {
            triggerGamification("üèÜ EARLY BIRD HARI INI!", res.nama, res.foto, "Apresiasi untuk semangat pagi yang luar biasa!");
            speak("Luar biasa! Kamu yang pertama datang hari ini, " + res.nama.split(" ")[0]);
          } else {
            playSFX('success'); 
            ucapan = generateUcapanNatural(res.nama, res.mode, res.keterangan, 'success');
            speak(ucapan);
          }

          rb.innerHTML = "<div style='color:var(--success); font-size:15px; font-weight:800; padding: 10px;'>‚úì Berhasil: " + (res.nama || res.message) + "</div>";
          setTimeout(function() { window.refreshUI(); }, 500);

        } else if (res && res.status === 'duplikat') {
          playSFX('error'); 
          rb.innerHTML = "<div style='color:var(--warning); font-size:14px; font-weight:800; padding: 10px;'>‚ö† " + (res.message || 'Anda sudah scan') + "</div>";
          ucapan = generateUcapanNatural(res.nama, res.mode, res.keterangan, 'duplikat');
          speak(ucapan);

        } else {
          playSFX('error'); 
          rb.innerHTML = "<div style='color:var(--danger); font-size:14px; font-weight:800; padding: 10px;'>‚úó " + (res ? (res.pesan || res.message) : 'Gagal memproses') + "</div>";
          ucapan = generateUcapanNatural("", "", "", "error");
          speak(ucapan);
        }

        setTimeout(function() { 
          rb.innerHTML = defaultStatusHTML; 
          document.getElementById("quote-box-v").classList.remove("hidden"); 
        }, 3000);
      })
      .withFailureHandler(function(err) {
        console.error("Presensi gagal terkirim:", err);
        handleOfflineSave(nik, photo);
      })
      .simpanPresensi(nik, photo);
  };

  window.refreshUI = function() {
    google.script.run
      .withSuccessHandler(function(data) {
        if(!data) return;
        
        var currentCount = data.logs ? data.logs.length : 0;
        var latestLogName = (data.logs && data.logs.length > 0 && data.logs[0].nama) ? data.logs[0].nama : "empty";
        var latestLogTime = (data.logs && data.logs.length > 0 && data.logs[0].waktu) ? data.logs[0].waktu : "00:00";
        
        var currentSignature = currentCount + "_" + latestLogName + "_" + latestLogTime;

        if (currentSignature === windowDataSignature) return; 
        windowDataSignature = currentSignature;

        var list = document.getElementById("list-v");
        if (!list) return;
        
        list.innerHTML = "";
        
        if (data.logs && data.logs.length > 0) {
          data.logs.forEach(function(log, index) {
            var inisial = log.nama ? log.nama.charAt(0).toUpperCase() : "?";
            var fallbackAvatar = "https://ui-avatars.com/api/?name=" + inisial + "&background=1e293b&color=fff&size=200";
            
            var img = fallbackAvatar;
            if (log.foto && typeof log.foto === 'string' && log.foto.length > 10) {
              img = log.foto;
              if (img.includes("drive.google.com")) {
                 var matchID = img.match(/[-\w]{25,}/);
                 if (matchID) img = "https://drive.google.com/thumbnail?id=" + matchID[0];          
              }
            }

            var teksWaktu = String(log.waktu);
            var ambilJam = teksWaktu.match(/\d{2}:\d{2}(:\d{2})?/);
            var waktuBersih = ambilJam ? ambilJam[0] : teksWaktu; 
            
            var badgeStyle = "background:rgba(255,255,255,0.05); color:#fff;";
            var statusColor = "#94a3b8";
            var status = log.mode ? log.mode.toLowerCase() : '';
            
            if (status === 'masuk') { 
              badgeStyle = "background:rgba(16,185,129,0.15); color:#34d399; border: 1px solid rgba(16,185,129,0.2);"; 
              statusColor = (log.keterangan !== 'Normal' && log.keterangan !== 'Tepat Waktu') ? "var(--danger)" : "var(--success)"; 
            }
            else if (status === 'pulang') { 
              badgeStyle = "background:rgba(245,158,11,0.15); color:#fbbf24; border: 1px solid rgba(245,158,11,0.2);"; 
              statusColor = (log.keterangan !== 'Normal' && log.keterangan !== 'Tepat Waktu') ? "var(--danger)" : "var(--success)"; 
            }
            else if (status === 'lembur') {
              badgeStyle = "background:rgba(168,85,247,0.15); color:#c084fc; border: 1px solid rgba(168,85,247,0.2);";
            }
            else if (status === 'izin' || status === 'sakit') {
              badgeStyle = "background:rgba(239,68,68,0.15); color:#f87171; border: 1px solid rgba(239,68,68,0.2);";
            }

            var cardHTML = "<div class='card-v' style='animation-delay: " + (index * 0.05) + "s'>" +
              "<div class='card-img-box'>" +
                "<img src='" + img + "' alt='User' onerror=\"this.onerror=null; this.src='" + fallbackAvatar + "';\">" +
              "</div>" +
              "<div class='card-body'>" +
                "<div class='card-name'>" + log.nama + "</div>" +
                "<div class='card-role'>" + log.jabatan + "</div>" +
                "<div class='card-meta'>" +
                  "<div style='display:flex; flex-direction:column;'>" +
                    "<span class='card-time'>" + waktuBersih + "</span>" +
                    "<span class='card-status-text' style='color:" + statusColor + "'>" + log.keterangan + "</span>" +
                  "</div>" +
                  "<span class='card-badge' style='" + badgeStyle + "'>" + log.mode + "</span>" +
                "</div>" +
              "</div>" +
            "</div>";
            list.insertAdjacentHTML('beforeend', cardHTML);
          });

          document.getElementById("total-count-v").innerText = data.logs.length + " REKAMAN";

          if(data.stats) {
            updateStatSmooth("s-masuk", data.stats.masuk);
            updateStatSmooth("s-pulang", data.stats.pulang);
            updateStatSmooth("s-izin", data.stats.izin);
            updateStatSmooth("s-sakit", data.stats.sakit); 
            updateStatSmooth("s-lembur", data.stats.lembur);
          }
          
          if(data.first) {
            var award = document.getElementById("award-v");
            award.style.display = "flex";
            document.getElementById("award-name").innerText = data.first.nama;
            document.getElementById("award-img").src = (data.first.foto && data.first.foto.length > 50) ? data.first.foto : ("https://ui-avatars.com/api/?name=" + data.first.nama.charAt(0) + "&background=random&color=fff");
          }
        }
      })
      .withFailureHandler(function(err){ /* Supress error saat offline */ })
      .getScannerData();
  };

  function updateStatSmooth(id, value) {
    var el = document.getElementById(id);
    if (el && el.innerText != value) {
      el.style.transform = "scale(1.2)";
      el.style.transition = "0.3s";
      setTimeout(function() {
        if (el) { // Tambahan aman
          el.innerText = value || 0;
          el.style.transform = "scale(1)";
        }
      }, 1500);
    }
  }
</script>

<script>
  // Mock API Testing Mode
  if (typeof google === 'undefined') {
    console.warn('Google Apps Script not loaded - running in standalone mode');
    var mockScanCount = 0;
    
    window.google = {
      script: {
        run: {
          withSuccessHandler: function(onSuccess) {
            var runner = {
              withFailureHandler: function(onFailure) { return runner; },
              getPresensiScannerSettings: function() { onSuccess({ info: 'Testing Mode', nama: 'Kiosk Scanner' }); return runner; },
              getScannerData: function() { onSuccess({ stats: { masuk: 0, pulang: 0, izin: 0, sakit: 0, lembur: 0 }, logs: [], first: null }); return runner; },
              simpanPresensi: function() { 
                mockScanCount++;
                var isEarlyBird = (mockScanCount === 1); 
                onSuccess({ 
                  status: 'success', 
                  message: 'Data Tersimpan', 
                  nama: 'Bapak/Ibu Guru', 
                  mode: 'Masuk', 
                  keterangan: 'Tepat Waktu',
                  is_early_bird: isEarlyBird 
                }); 
                return runner; 
              },
              getCurrentSessionMode: function() { onSuccess({mode: 'MASUK BERLANGSUNG'}); return runner; },
              getScriptUrl: function() { onSuccess("https://script.google.com/macros/s/testing/exec"); return runner; }
            };
            return runner;
          },
          withFailureHandler: function(onFailure) {
            var runner = {
              withSuccessHandler: function(onSuccess) { return runner; },
              getPresensiScannerSettings: function() { return runner; },
              getScannerData: function() { return runner; },
              simpanPresensi: function() { return runner; },
              getCurrentSessionMode: function() { return runner; },
              getScriptUrl: function() { return runner; }
            };
            return runner;
          }
        }
      }
    };
  }
</script>
</body>
</html>