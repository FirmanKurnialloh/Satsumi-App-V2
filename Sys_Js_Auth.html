<script>
  // --- [SYSTEM] PEMBERSIHAN DATA SESI LAMA ---
  (function cleanUpOldData() {
    try {
      if (STORAGE.getItem("user") || STORAGE.getItem("sess_u")) {
        const cek = STORAGE.getItem("sess_u_aes");
        if(!cek) STORAGE.clear();
      }
    } catch (e) {
      console.warn("Storage cleanup failed:", e);
    }
  })();

  const oldOnload = window.onload;
  window.onload = function() {
    if (oldOnload) oldOnload();
    if (typeof initTheme === "function") initTheme();
    
    const encUser = STORAGE.getItem("sess_u_aes");
    const token = STORAGE.getItem("sess_t");
    // Prefer server-side `URL_PARAMS` but fall back to actual URL search params
    let v = null;
    try {
      if (typeof URL_PARAMS !== 'undefined' && URL_PARAMS && URL_PARAMS.v) v = URL_PARAMS.v;
    } catch(e) { /* ignore */ }
    try {
      if (!v) {
        const sp = new URLSearchParams(location.search);
        v = sp.get('v');
      }
    } catch(e) { /* ignore */ }

    // --- [ROUTING] BYPASS KHUSUS SCANNER/KIOSK (PUBLIC) ---
    if (v === 'scanner' || v === 'kiosk') {
      // If an early request already started loading the module, skip duplicate call
      if (!window.__sdmRequested) window.__sdmRequested = true;
      if (!window.__sdmLoaded) {
        try { loadSdmModule(v); window.__sdmLoaded = true; } catch(e) { console.warn('loadSdmModule failed on onload', e); }
      }
      return;
    }

    // --- [ROUTING] CEK SESI USER ---
    if (encUser && token) {
      const user = decryptAES(encUser);
      if (!user) { forceLogout("Sesi tidak valid."); return; }

      google.script.run
        .withSuccessHandler(res => {
          if (res.valid) {
            STORAGE.setItem("sess_u_aes", encryptAES(res.freshUser));
            routeUserToDashboard(res.freshUser);
          } else {
            forceLogout(res.reason || "Sesi berakhir.");
          }
        })
        .withFailureHandler(err => {
          console.error("Session Validation Error:", err);
          forceLogout("Gagal validasi sesi. Cek koneksi.");
        })
        .validateSessionToken(token, user);
    } else {
      // If v=scanner was passed via URL but not handled above, ensure scanner loads
      if (v === 'scanner' || v === 'kiosk') {
        if (!window.__sdmRequested) window.__sdmRequested = true;
        try { if (!window.__sdmLoaded) { loadSdmModule(v); window.__sdmLoaded = true; } } catch(e) { console.warn('late loadSdmModule failed', e); }
        return;
      }

      // Delay sedikit untuk efek transisi halus
      setTimeout(() => {
        if (typeof switchView === "function") switchView('view-login');
      }, 800);
    }

    // --- [UI] ANTI GOOGLE WARNING BAR ---
    const zapGoogleWarning = () => {
      const selectors = [
        '#warning', 
        '.warning-bar', 
        '.warning-banner-bar', 
        '.apps-script-notice-container', 
        '.apps-script-notice-bar'
      ];
      selectors.forEach(s => {
        document.querySelectorAll(s).forEach(el => { 
          el.style.setProperty('display', 'none', 'important'); 
          el.remove(); 
        });
      });
    };
    zapGoogleWarning(); 
    const zapInterval = setInterval(zapGoogleWarning, 100); 
    setTimeout(() => clearInterval(zapInterval), 5000);
  };

  /**
   * --- [ROUTER] FUNGSI LOAD MODUL SIPGTK ---
   * Mengoptimalkan pemuatan modul scanner/admin secara dinamis.
   */
  function loadSdmModule(v) {
    const container = document.getElementById('sdm-module-container');
    const loading = document.getElementById('view-loading');
    
    // Sembunyikan view bawaan Satsumi
    if(document.getElementById('satsumi-core-views')) {
      document.getElementById('satsumi-core-views').style.display = 'none';
    }
    
    if (container) {
      container.classList.remove('hidden');
      container.style.display = 'block';
    }

    // For scanner/kiosk modes we must load the page as a top-level document.
    if (v === 'scanner' || v === 'kiosk') {
      try {
        const target = (typeof BASE_URL !== 'undefined') ? (BASE_URL + '?v=' + v) : (location.pathname + '?v=' + v);
        const a = document.createElement('a');
        a.href = target;
        a.target = '_top';
        document.body.appendChild(a);
        a.click();
        return;
      } catch(e) {
        console.warn('Top-level redirect for scanner failed, fallback to location', e);
        location.href = (typeof BASE_URL !== 'undefined') ? (BASE_URL + '?v=' + v) : (location.pathname + '?v=' + v);
        return;
      }
    }

    // For other modules, fetch HTML and inject only safe external scripts.
    let targetFile = 'Adm_View_SDM';
    google.script.run
      .withSuccessHandler(function(html) {
        if (!container) return;
        container.innerHTML = html;

        if (loading) {
          loading.classList.remove('active');
          loading.style.display = 'none';
        }

        // Load only external scripts referenced by the returned HTML to avoid
        // executing modern inline module code in the parent context.
        const scripts = container.querySelectorAll('script');
        scripts.forEach(s => {
          try {
            if (s.src) {
              const ext = document.createElement('script');
              if (s.type) ext.type = s.type;
              ext.src = s.src;
              document.head.appendChild(ext);
            }
          } catch (e) {
            console.warn('Failed to append external script', e);
          }
          if (s.parentNode) s.parentNode.removeChild(s);
        });
      })
      .withFailureHandler(err => {
        console.error('Gagal load modul ' + targetFile + ':', err);
        if (loading) loading.classList.remove('active');
        showToast('Gagal memuat sistem.', 'error');
      })
      .include(targetFile);
  }

  /**
   * --- [AUTH] HANDLING LOGIN ---
   */
  function handleLogin(e) {
    if (e) e.preventDefault();
    const email = document.getElementById('email').value;
    const pass = document.getElementById('pass').value;
    
    if(!email || !pass) return showToast("Lengkapi email & password!", "error");
    
    if (typeof showLoading === "function") showLoading("OTENTIKASI AKUN...");
    
    google.script.run
      .withSuccessHandler(res => {
        if (res.status === 'success') {
          STORAGE.setItem("sess_t", res.token);
          STORAGE.setItem("sess_u_aes", encryptAES(res.user));
          if (typeof showLoading === "function") showLoading("LOGIN BERHASIL...");
          
          setTimeout(() => {
            const a = document.createElement('a');
            // Prefer server-side URL_PARAMS but fall back to actual URL search params
            let targetV = '';
            try {
              if (typeof URL_PARAMS !== 'undefined' && URL_PARAMS && URL_PARAMS.v) targetV = '?v=' + URL_PARAMS.v;
            } catch(e) {}
            try {
              if (!targetV) {
                const sp = new URLSearchParams(location.search);
                const v2 = sp.get('v');
                if (v2) targetV = '?v=' + v2;
              }
            } catch(e) {}
            const baseUrl = (typeof BASE_URL !== 'undefined' && BASE_URL) ? BASE_URL : location.pathname;
            a.href = baseUrl + targetV;
            a.target = "_top"; 
            document.body.appendChild(a);
            a.click();
          }, 500);
        } else {
          if (typeof switchView === "function") switchView('view-login'); 
          showToast(res.message || "Login gagal.", "error");
        }
      })
      .withFailureHandler(err => {
        console.error("Login Error:", err);
        if (typeof switchView === "function") switchView('view-login');
        showToast("Kesalahan server. Coba lagi.", "error");
      })
      .checkLogin({ email, password: pass });
  }

  /**
   * --- [DASHBOARD] ROLE BASED ROUTING ---
   */
  function routeUserToDashboard(user) {
    const sdmContainer = document.getElementById('sdm-module-container');
    if(sdmContainer) { 
      sdmContainer.classList.add('hidden'); 
      sdmContainer.innerHTML = ""; 
    }
    
    const coreViews = document.getElementById('satsumi-core-views');
    if(coreViews) coreViews.classList.remove('hidden');

    const userRole = (user.role || "").toUpperCase();
    if (userRole.includes('ADMIN') || userRole.includes('SUPER')) {
      if(typeof initDashboard === "function") initDashboard(user);
    } else if (userRole.includes('GURU')) {
      if(typeof initDashboardGuru === "function") initDashboardGuru(user);
    } else {
      forceLogout("Role tidak dikenali oleh sistem.");
    }
  }

  // --- [LOGOUT] FUNCTIONS ---
  function forceLogout(msg) { 
    STORAGE.clear(); 
    if(msg) showToast(msg, "error"); 
    if (typeof switchView === "function") switchView('view-login'); 
  }

  function logout() { 
    const modal = document.getElementById('modal-logout');
    if(modal) modal.classList.add('show'); 
  }

  function closeLogoutModal() { 
    const modal = document.getElementById('modal-logout');
    if(modal) modal.classList.remove('show'); 
  }

  function confirmLogout() {
    STORAGE.clear(); 
    closeLogoutModal();
    if (typeof showLoading === "function") showLoading("SEDANG KELUAR...");
    
    try {
      const baseUrl = (typeof getBaseUrl === 'function') ? getBaseUrl() : ((typeof BASE_URL !== 'undefined' && BASE_URL) ? BASE_URL : location.pathname);
      const a = document.createElement('a');
      a.href = baseUrl;
      a.target = "_top"; 
      document.body.appendChild(a);
      a.click();
    } catch(e) {
      console.error('Logout redirect failed:', e);
      location.href = location.pathname;
    }
  }
</script>