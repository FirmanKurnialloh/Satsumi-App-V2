<script>
  /**
   * GLOBAL CACHE
   * Menyimpan data sementara agar bisa diakses oleh fungsi modal detail tanpa error parsing.
   */
  let REKAP_DATA_CACHE = [];

  // === INIT & NAVIGASI ADMIN ===
  function initDashboard(user) {
    const elName = document.getElementById('profile-name');
    const elRole = document.getElementById('profile-role');
    const elInit = document.getElementById('profile-initial');

    if (!elName || !elRole || !elInit) {
      console.error("üö® ERROR UI: Elemen Topbar tidak ditemukan!");
    } else {
      elName.innerText = user.nama;
      elRole.innerText = user.role;
      elInit.innerText = user.nama.charAt(0).toUpperCase();
    }
    
    switchView('view-dashboard');
    
    let currentHash = window.location.hash.substring(1);
    if (!currentHash) currentHash = 'dashboard';
    navTo(currentHash); 
  }

  window.addEventListener("hashchange", function() {
    let currentHash = window.location.hash.substring(1);
    if(currentHash) navTo(currentHash);
  });

  // === UI & SIDEBAR ===
  function toggleSubmenu(submenuId, arrowId) {
    const submenu = document.getElementById(submenuId);
    const arrow = document.getElementById(arrowId);
    if (submenu) {
      submenu.classList.toggle('open');
      if (arrow) arrow.classList.toggle('rotate');
    }
  }

  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    if (window.innerWidth <= 768) {
      sidebar.classList.toggle('open');
      overlay.classList.toggle('show');
    } else {
      sidebar.classList.toggle('closed');
    }
  }

  function navTo(pageId) {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    const navEl = document.getElementById('nav-' + pageId);
    if(navEl) navEl.classList.add('active');

    document.querySelectorAll('.content-section').forEach(el => {
      el.classList.remove('active-page');
      el.style.display = 'none'; 
    });

    const target = document.getElementById('page-' + pageId);
    if(target) {
      target.style.display = 'block'; 
      setTimeout(() => target.classList.add('active-page'), 10);
    }

    const titles = { 
      'dashboard': 'Dashboard Overview', 
      'users': 'Manajemen Pengguna', 
      'settings': 'Pengaturan Sistem',
      'presensi-harian-rekap': 'Rekapitulasi Presensi Harian',
      'presensi-harian-setting': 'Pengaturan Jam Kerja',
      'presensi-harian-cetak': 'Cetak Laporan Bulanan',
      'presensi-kegiatan-rekap': 'Rekapitulasi Presensi Kegiatan'
    };
    document.getElementById('page-title').innerText = titles[pageId] || 'Dashboard';

    const token = STORAGE.getItem("sess_t");
    
    try {
      const targetHash = '#' + pageId;
      if (location.hash !== targetHash) location.hash = targetHash;
    } catch (e) { }
    
    if(pageId === 'dashboard') loadStats(token);
    if(pageId === 'users') loadUsers(token);
    if(pageId === 'settings') loadSettings(token);
    if(pageId === 'presensi-harian-rekap') loadRekapHarian();

    if (window.innerWidth <= 768 && document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
  }

  // === DATA LOADERS ===
  function loadStats(token) {
    google.script.run.withSuccessHandler(data => {
      document.getElementById('stat-total').innerText = data.stats.total;
      document.getElementById('stat-total-guru').innerText = data.stats.guru;
      document.getElementById('stat-total-tendik').innerText = data.stats.tendik; 
      document.getElementById('stat-siswa').innerText = data.stats.siswa;
      document.getElementById('stat-hadir').innerText = data.stats.persenPresensi + '%'; 
      const tbody = document.getElementById('table-recent'); tbody.innerHTML = "";
      data.table.forEach(u => renderRow(tbody, u));
    }).getAdminDashboardData(token);
  }

  function renderRow(tbody, u) {
    let badgeClass = 'badge-siswa';
    if(u.role === 'Admin' || u.role === 'Super Admin') badgeClass = 'badge-admin';
    if(u.role === 'Guru') badgeClass = 'badge-guru';
    if(u.role === 'Tendik') badgeClass = 'badge-tendik';
    tbody.innerHTML += '<tr><td style="font-family:monospace;">'+u.nik+'</td><td><strong>'+u.nama+'</strong></td><td><span class="badge '+badgeClass+'">'+u.role+'</span></td><td><span style="color:var(--success);font-size:12px;">‚óè '+u.status+'</span></td></tr>';
  }

  function loadUsers(token) {
    const tbody = document.getElementById('table-users');
    if ($.fn.DataTable.isDataTable('#userTable')) {
      $('#userTable').DataTable().clear().destroy();
      $('#userTable tbody').empty();
    }
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Mengambil data...</td></tr>';
    google.script.run.withSuccessHandler(users => {
      tbody.innerHTML = "";
      if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Tidak ada data.</td></tr>';
        return;
      }
      users.forEach(u => {
        let roleBadge = '<span class="badge badge-siswa">'+u.role+'</span>';
        if(u.role.includes('Admin')) roleBadge = '<span class="badge badge-admin">'+u.role+'</span>';
        if(u.role === 'Guru') roleBadge = '<span class="badge badge-guru">'+u.role+'</span>';
        if(u.role === 'Tendik') roleBadge = '<span class="badge badge-tendik">'+u.role+'</span>';
        
        tbody.innerHTML += '<tr>' +
          '<td style="font-family:monospace; font-weight:600;">'+u.nik+'</td>' +
          '<td><b>'+u.nama+'</b></td><td>'+u.email+'</td><td>'+roleBadge+'</td>' +
          '<td style="display:flex; gap:5px;">' +
            '<button class="btn" style="background:var(--primary);padding:6px 10px;" data-nik="'+u.nik+'" data-nama="'+u.nama+'" data-email="'+u.email+'" data-role="'+u.role+'" onclick="openEditUserModal(this)"><i class="bi bi-pencil-fill"></i></button>' +
            '<button class="btn" style="background:#f59e0b;padding:6px 10px;" data-nik="'+u.nik+'" data-nama="'+u.nama+'" onclick="openResetModalFromBtn(this)"><i class="bi bi-key-fill"></i></button>' +
            '<button class="btn btn-danger-outline" style="padding:6px 10px;" onclick="hapusUser(\''+u.nik+'\')"><i class="bi bi-trash-fill"></i></button>' +
          '</td></tr>';
      });
      $('#userTable').DataTable({ "retrieve": true, "pageLength": 10, "language": { "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/id.json" } });
    }).getAllUsers(token);
  }

  /**
   * LOAD REKAP HARIAN (Index-Based Click)
   */
  function loadRekapHarian() {
    const token = STORAGE.getItem("sess_t");
    const tbody = document.getElementById('table-rekap-harian');
    const inputTgl = document.getElementById('filter-tanggal-presensi');
    
    if (inputTgl && !inputTgl.value) {
      inputTgl.value = new Date().toISOString().split('T')[0];
    }
    const targetDate = inputTgl ? inputTgl.value : "";

    if ($.fn.DataTable.isDataTable('#rekapHarianTable')) {
      $('#rekapHarianTable').DataTable().clear().destroy();
      $('#rekapHarianTable tbody').empty();
    }
    
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px;"><div class="spinner-border text-primary"></div></td></tr>';

    google.script.run.withSuccessHandler(data => {
      tbody.innerHTML = "";
      REKAP_DATA_CACHE = data; // Simpan data ke memori global

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px; color: #94a3b8;">Tidak ada data presensi pada tanggal '+targetDate+'</td></tr>';
        return;
      }

      data.forEach((row, index) => {
        const isLate = row.keterangan.toLowerCase().includes('terlambat');
        const statusBadgeClass = row.status === 'Masuk' ? 'badge-guru' : 'badge-admin';
        const avatar = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(row.nama) + '&background=random';
        
        tbody.innerHTML += '<tr style="cursor:pointer" onclick="showDetailPresensi(' + index + ')">' +
          '<td><strong style="color:var(--primary);">' + row.jam + '</strong></td>' +
          '<td>' +
            '<div style="display:flex;align-items:center;gap:12px;">' +
              '<img src="' + (row.foto || avatar) + '" style="width:40px;height:40px;border-radius:10px;object-fit:cover;border:1px solid var(--border);">' +
              '<div>' +
                '<div style="font-weight:700;color:var(--text);">' + row.nama + '</div>' +
                '<div style="font-size:0.75rem;color:var(--sub);">NIK: ' + row.nik + '</div>' +
              '</div>' +
            '</div>' +
          '</td>' +
          '<td><span class="badge ' + statusBadgeClass + '">' + row.status + '</span></td>' +
          '<td>' +
            '<div style="font-size:0.85rem;color:' + (isLate ? 'var(--danger)' : 'var(--sub)') + ';font-weight:' + (isLate ? '600' : '400') + '">' + row.keterangan + '</div>' +
            '<div style="font-size:0.7rem;text-transform:uppercase;opacity:0.6;">' + row.jabatan + '</div>' +
          '</td>' +
        '</tr>';
      });

      $('#rekapHarianTable').DataTable({ 
        "retrieve": true, 
        "pageLength": 10, 
        "order": [[0, "desc"]],
        "language": { "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/id.json", "search": "" }, 
        "dom": '<"top-actions"f>rt<"bottom-nav"ip>' 
      });
    }).getRekapHarian(token, targetDate);
  }

  /**
   * SHOW DETAIL MODAL (Global Scope)
   */
  window.showDetailPresensi = function(index) {
    const data = REKAP_DATA_CACHE[index];
    if (!data) return;

    // Pastikan elemen modal ada sebelum diisi
    const elNama = document.getElementById('detail-nama');
    if (!elNama) return;

    elNama.innerText = data.nama;
    document.getElementById('detail-jabatan').innerText = data.jabatan || '-';
    document.getElementById('detail-nik').innerText = data.nik || '-';
    document.getElementById('detail-waktu').innerText = data.jam || '--:--';
    document.getElementById('detail-keterangan').innerText = data.keterangan || '-';
    document.getElementById('detail-foto').src = data.foto || ('https://ui-avatars.com/api/?name=' + encodeURIComponent(data.nama));
    
    const badge = document.getElementById('detail-badge-status');
    if (badge) {
      badge.innerText = data.status;
      badge.className = 'badge ' + (data.status === 'Masuk' ? 'badge-guru' : 'badge-admin');
    }
    
    document.getElementById('modal-detail-presensi').classList.add('show');
  };

  function loadSettings(token) {
    google.script.run.withSuccessHandler(data => {
      document.getElementById('set-app-name').value = data.appName; 
      document.getElementById('set-app-desc').value = data.appDesc;
      document.getElementById('set-maintenance').checked = data.maintenance; 
      document.querySelector('.sidebar-title').innerText = data.appName;
      document.getElementById('server-time').innerText = new Date().toLocaleString();
    }).getSystemSettings(token);
  }

  // === FUNGSI PENGATURAN HARIAN ===
  function simpanJadwalHarian() {
    const token = STORAGE.getItem("sess_t");
    const form = {
      jamMasuk: document.getElementById('set-harian-masuk').value,
      jamToleransi: document.getElementById('set-harian-toleransi').value,
      jamPulang: document.getElementById('set-harian-pulang').value
    };

    if(!form.jamMasuk || !form.jamToleransi || !form.jamPulang) {
      return showToast("Harap lengkapi semua pengaturan waktu!", "error");
    }

    showLoading("MENYIMPAN KONFIGURASI...");
    google.script.run.withSuccessHandler(res => {
      showToast(res.message, res.status);
      if(res.status === 'success') setTimeout(() => navTo('presensi-harian-rekap'), 1500);
    }).saveHarianSettings(token, form);
  }

  // === FUNGSI CRUD USER ===
  function openAddUserModal() { document.getElementById('modal-add-user').classList.add('show'); }
  function closeUserModal() { document.getElementById('modal-add-user').classList.remove('show'); }
  
  function handleUserSubmit(e) {
    e.preventDefault();
    closeUserModal();
    showLoading("MENYIMPAN...");
    const token = STORAGE.getItem("sess_t");
    const form = {
      nik: document.getElementById('new-nik').value,
      nama: document.getElementById('new-nama').value,
      email: document.getElementById('new-email').value,
      role: document.getElementById('new-role').value
    };
    google.script.run.withSuccessHandler(res => {
      if (res.status === 'success') {
        loadUsers(token);
        if (res.temp) openTempPassModal(res.temp, form.nama, form.nik);
      } else {
        showToast(res.message, res.status);
      }
      switchView('view-dashboard');
    }).saveUser(token, form);
  }

  function openEditUserModal(btn) { 
    document.getElementById('edit-nik').value = btn.getAttribute('data-nik');
    document.getElementById('edit-nama').value = btn.getAttribute('data-nama');
    document.getElementById('edit-email').value = btn.getAttribute('data-email');
    document.getElementById('edit-role').value = btn.getAttribute('data-role');
    document.getElementById('modal-edit-user').classList.add('show'); 
  }
  
  function closeEditUserModal() { document.getElementById('modal-edit-user').classList.remove('show'); }

  function openResetModalFromBtn(btn) {
    const nik = btn.getAttribute('data-nik');
    const nama = btn.getAttribute('data-nama');
    document.getElementById('reset-target-name').innerText = nama;
    document.getElementById('reset-target-nik').value = nik;
    document.getElementById('modal-reset').classList.add('show');
  }

  function confirmResetPassword() {
    const nik = document.getElementById('reset-target-nik').value;
    const token = STORAGE.getItem("sess_t");
    document.getElementById('modal-reset').classList.remove('show');
    showLoading("MERESET...");
    google.script.run.withSuccessHandler(res => {
      if (res.status === 'success') openTempPassModal(res.temp, document.getElementById('reset-target-name').innerText, nik);
      else showToast(res.message, 'error');
      switchView('view-dashboard');
    }).resetUserPassword(token, nik);
  }

  function hapusUser(nik) {
    document.getElementById('delete-target-nik-value').value = nik;
    document.getElementById('delete-target-nik-display').innerText = nik;
    document.getElementById('modal-delete-user').classList.add('show');
  }

  function confirmDeleteUser() {
    const nik = document.getElementById('delete-target-nik-value').value;
    const token = STORAGE.getItem("sess_t");
    document.getElementById('modal-delete-user').classList.remove('show');
    showLoading("MENGHAPUS...");
    google.script.run.withSuccessHandler(res => {
      showToast(res.message, res.status);
      loadUsers(token);
      switchView('view-dashboard');
    }).deleteUser(token, nik);
  }

  function openTempPassModal(pass, name, nik) {
    document.getElementById('temp-pass-value').innerText = pass;
    document.getElementById('temp-pass-name').innerText = name;
    document.getElementById('temp-pass-nik').innerText = nik;
    document.getElementById('modal-temp-pass').classList.add('show');
  }

  function closeTempPassModal() {
    document.getElementById('modal-temp-pass').classList.remove('show');
  }

  function copyTempPass() { 
    const val = document.getElementById('temp-pass-value').innerText; 
    navigator.clipboard.writeText(val).then(() => showToast('Password disalin','success')); 
  }

  function handleSaveSettings(e) { 
    e.preventDefault(); 
    const token = STORAGE.getItem("sess_t"); 
    showLoading("MENYIMPAN..."); 
    const form = { appName: document.getElementById('set-app-name').value, appDesc: document.getElementById('set-app-desc').value }; 
    google.script.run.withSuccessHandler(res => { 
      showToast(res.message, res.status); 
      switchView('view-dashboard'); 
      document.querySelector('.sidebar-title').innerText = form.appName; 
    }).saveSystemSettings(token, form); 
  }

  function handleMaintenanceToggle(el) { 
    const token = STORAGE.getItem("sess_t"); 
    google.script.run.withSuccessHandler(res => showToast(res.message, res.status)).toggleMaintenanceMode(token, el.checked); 
  }

  function logout() {
    STORAGE.removeItem("sess_t");
    STORAGE.removeItem("sess_u");
    window.location.href = google.script.host.origin + google.script.history.location.pathname;
  }
</script>