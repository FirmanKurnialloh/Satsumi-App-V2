<script>
  /**
   * GLOBAL VARIABLES & INSTANCES
   * Digunakan untuk mengelola data sementara dan instance tabel agar tidak bentrok.
   */
  let REKAP_DATA_CACHE = [];
  let USER_TABLE_INST = null;
  let REKAP_TABLE_INST = null;
  let REKAP_POLLING = null; 

  // === INIT & NAVIGASI ADMIN ===
  function initDashboard(user) {
    const elName = document.getElementById('profile-name');
    const elRole = document.getElementById('profile-role');
    const elInit = document.getElementById('profile-initial');

    if (elName) elName.innerText = user.nama;
    if (elRole) elRole.innerText = user.role;
    if (elInit) elInit.innerText = user.nama.charAt(0).toUpperCase();
    
    switchView('view-dashboard');
    
    let currentHash = window.location.hash.substring(1) || 'dashboard';
    navTo(currentHash); 
  }

  window.addEventListener("hashchange", function() {
    let currentHash = window.location.hash.substring(1);
    if(currentHash) navTo(currentHash);
  });

  /**
   * NAVIGASI ANTAR HALAMAN (FIX COLUMN WIDTH)
   */
  function navTo(pageId) {
    // Stop polling saat pindah halaman
    if (REKAP_POLLING) {
      clearInterval(REKAP_POLLING);
      REKAP_POLLING = null;
    }

    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    const navEl = document.getElementById('nav-' + pageId);
    if(navEl) navEl.classList.add('active');

    document.querySelectorAll('.content-section').forEach(el => {
      el.classList.remove('active-page');
      el.style.display = 'none'; 
    });

    const target = document.getElementById('page-' + pageId);
    if(target) {
      target.style.display = 'block'; 
      setTimeout(() => {
        target.classList.add('active-page');
        
        if (pageId === 'users' && USER_TABLE_INST) USER_TABLE_INST.columns.adjust().draw();
        if (pageId === 'presensi-harian-rekap' && REKAP_TABLE_INST) REKAP_TABLE_INST.columns.adjust().draw();
      }, 50);
    }

    const titles = { 
      'dashboard': 'Dashboard Overview', 
      'users': 'Manajemen Pengguna', 
      'settings': 'Pengaturan Sistem',
      'presensi-harian-rekap': 'Rekapitulasi Presensi Harian',
      'presensi-harian-setting': 'Pengaturan Jam Kerja',
      'presensi-harian-cetak': 'Cetak Laporan Bulanan',
      'presensi-kegiatan-rekap': 'Rekapitulasi Presensi Kegiatan'
    };
    document.getElementById('page-title').innerText = titles[pageId] || 'Dashboard';

    const token = STORAGE.getItem("sess_t");
    if(pageId === 'dashboard') loadStats(token);
    if(pageId === 'users') loadUsers(token);
    if(pageId === 'settings') loadSettings(token);
    
    // Logika Khusus Halaman Presensi
    if(pageId === 'presensi-harian-rekap') {
      loadRekapHarian(); 
      REKAP_POLLING = setInterval(loadRekapHarianSilent, 30000);
    }

    // --- BARU: Load data jam kerja saat masuk ke halaman pengaturan ---
    if(pageId === 'presensi-harian-setting') {
      loadHarianSettings();
    }

    if (window.innerWidth <= 768 && document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
  }

  // === DATA LOADERS ===
  function loadStats(token) {
    google.script.run.withSuccessHandler(data => {
      document.getElementById('stat-total').innerText = data.stats.total;
      document.getElementById('stat-total-guru').innerText = data.stats.guru;
      document.getElementById('stat-total-tendik').innerText = data.stats.tendik; 
      document.getElementById('stat-siswa').innerText = data.stats.siswa;
      document.getElementById('stat-hadir').innerText = data.stats.persenPresensi + '%'; 
      const tbody = document.getElementById('table-recent'); tbody.innerHTML = "";
      data.table.forEach(u => renderRow(tbody, u));
    }).getAdminDashboardData(token);
  }

  function renderRow(tbody, u) {
    let badgeClass = 'badge-siswa';
    if(u.role === 'Admin' || u.role === 'Super Admin') badgeClass = 'badge-admin';
    if(u.role === 'Guru') badgeClass = 'badge-guru';
    if(u.role === 'Tendik') badgeClass = 'badge-tendik';
    tbody.innerHTML += '<tr><td style="font-family:monospace;">'+u.nik+'</td><td><strong>'+u.nama+'</strong></td><td><span class="badge '+badgeClass+'">'+u.role+'</span></td><td><span style="color:var(--success);font-size:12px;">‚óè '+u.status+'</span></td></tr>';
  }

  function loadUsers(token) {
    const tbody = document.getElementById('table-users');
    if ($.fn.DataTable.isDataTable('#userTable')) {
      $('#userTable').DataTable().destroy();
      $(tbody).empty();
    }
    
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Mengambil data pengguna...</td></tr>';
    
    google.script.run.withSuccessHandler(users => {
      tbody.innerHTML = "";
      if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Tidak ada data.</td></tr>';
        return;
      }
      users.forEach(u => {
        let roleBadge = '<span class="badge badge-siswa">'+u.role+'</span>';
        if(u.role.includes('Admin')) roleBadge = '<span class="badge badge-admin">'+u.role+'</span>';
        if(u.role === 'Guru') roleBadge = '<span class="badge badge-guru">'+u.role+'</span>';
        if(u.role === 'Tendik') roleBadge = '<span class="badge badge-tendik">'+u.role+'</span>';
        
        tbody.innerHTML += '<tr>' +
          '<td style="font-family:monospace; font-weight:600;">'+u.nik+'</td>' +
          '<td><b>'+u.nama+'</b></td><td>'+u.email+'</td><td>'+roleBadge+'</td>' +
          '<td style="display:flex; gap:5px;">' +
            '<button class="btn-theme" style="width:32px;height:32px;background:var(--primary);color:white" data-nik="'+u.nik+'" data-nama="'+u.nama+'" data-email="'+u.email+'" data-role="'+u.role+'" onclick="openEditUserModal(this)"><i class="bi bi-pencil-fill" style="font-size:0.8rem"></i></button>' +
            '<button class="btn-theme" style="width:32px;height:32px;background:#f59e0b;color:white" data-nik="'+u.nik+'" data-nama="'+u.nama+'" onclick="openResetModalFromBtn(this)"><i class="bi bi-key-fill" style="font-size:0.8rem"></i></button>' +
            '<button class="btn-theme" style="width:32px;height:32px;background:var(--danger);color:white" onclick="hapusUser(\''+u.nik+'\')"><i class="bi bi-trash-fill" style="font-size:0.8rem"></i></button>' +
          '</td></tr>';
      });

      USER_TABLE_INST = $('#userTable').DataTable({
        "retrieve": true,
        "pageLength": 10,
        "language": { "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/id.json", "search": "" },
        "dom": '<"top-actions"f>rt<"bottom-nav"ip>'
      });
    }).getAllUsers(token);
  }

  /**
   * REKAP HARIAN LOGIC
   */
  function renderRekapTableBody(data) {
    const tbody = document.getElementById('table-rekap-harian');
    if (!tbody) return;

    if ($.fn.DataTable.isDataTable('#rekapHarianTable')) {
        $('#rekapHarianTable').DataTable().clear().destroy();
    }

    let html = "";
    data.forEach((row, index) => {
      const isLate = row.keterangan.toLowerCase().includes('terlambat');
      const statusBadgeClass = row.status === 'Masuk' ? 'badge-guru' : 'badge-admin';
      const avatar = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(row.nama);
      
      html += '<tr style="cursor:pointer" onclick="showDetailPresensi(' + index + ')">' +
          '<td><strong style="color:var(--primary);">' + row.jam + '</strong></td>' +
          '<td>' +
            '<div style="display:flex;align-items:center;gap:12px;">' +
              '<img src="' + (row.foto || avatar) + '" style="width:40px;height:40px;border-radius:10px;object-fit:cover;border:1px solid var(--border);">' +
              '<div>' +
                '<div style="font-weight:700;color:var(--text);">' + row.nama + '</div>' +
                '<div style="font-size:0.75rem;color:var(--sub);">NIK: ' + row.nik + '</div>' +
              '</div>' +
            '</div>' +
          '</td>' +
          '<td><span class="badge ' + statusBadgeClass + '">' + row.status + '</span></td>' +
          '<td>' +
            '<div style="font-size:0.85rem;color:' + (isLate ? 'var(--danger)' : 'var(--sub)') + ';font-weight:' + (isLate ? '600' : '400') + '">' + row.keterangan + '</div>' +
            '<div style="font-size:0.7rem;text-transform:uppercase;opacity:0.6;">' + row.jabatan + '</div>' +
          '</td>' +
        '</tr>';
    });
    
    tbody.innerHTML = html;

    REKAP_TABLE_INST = $('#rekapHarianTable').DataTable({ 
        "retrieve": true, 
        "pageLength": 10, 
        "order": [[0, "desc"]],
        "language": { "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/id.json", "search": "" }, 
        "dom": '<"top-actions"f>rt<"bottom-nav"ip>' 
    });
  }

  function loadRekapHarian() {
    const token = STORAGE.getItem("sess_t");
    const tbody = document.getElementById('table-rekap-harian');
    const inputTgl = document.getElementById('filter-tanggal-presensi');
    
    if (inputTgl && !inputTgl.value) inputTgl.value = new Date().toISOString().split('T')[0];
    const targetDate = inputTgl ? inputTgl.value : "";
    
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px;"><div class="spinner-border text-primary"></div></td></tr>';

    google.script.run.withSuccessHandler(data => {
      REKAP_DATA_CACHE = data;
      renderRekapTableBody(data);
    }).getRekapHarian(token, targetDate);
  }

  function loadRekapHarianSilent() {
    const token = STORAGE.getItem("sess_t");
    const inputTgl = document.getElementById('filter-tanggal-presensi');
    const targetDate = inputTgl ? inputTgl.value : new Date().toISOString().split('T')[0];
    
    const today = new Date().toISOString().split('T')[0];
    if (targetDate !== today) return; 

    google.script.run.withSuccessHandler(data => {
      if (data.length !== REKAP_DATA_CACHE.length) {
        REKAP_DATA_CACHE = data;
        renderRekapTableBody(data);
      }
    }).getRekapHarian(token, targetDate);
  }

  /**
   * SHOW DETAIL MODAL (GLOBAL)
   */
  window.showDetailPresensi = function(index) {
    const data = REKAP_DATA_CACHE[index];
    if (!data) return;

    const elNama = document.getElementById('detail-nama');
    if (elNama) elNama.innerText = data.nama;
    
    document.getElementById('detail-jabatan').innerText = data.jabatan || '-';
    document.getElementById('detail-nik').innerText = data.nik || '-';
    document.getElementById('detail-waktu').innerText = data.jam || '--:--';
    document.getElementById('detail-keterangan').innerText = data.keterangan || '-';
    document.getElementById('detail-foto').src = data.foto || ('https://ui-avatars.com/api/?name=' + encodeURIComponent(data.nama));
    
    const badge = document.getElementById('detail-badge-status');
    if (badge) {
      badge.innerText = data.status;
      badge.className = 'badge ' + (data.status === 'Masuk' ? 'badge-guru' : 'badge-admin');
    }
    
    document.getElementById('modal-detail-presensi').classList.add('show');
  };

  /**
 * FUNGSI: Buka Modal Pengaturan Jam Kerja
 */
function openSettingHarianModal() {
  const token = STORAGE.getItem("sess_t");
  
  // Beri indikasi loading (opsional jika Sys_Js_Global mendukung)
  showLoading("MENGAMBIL KONFIGURASI...");

  google.script.run
    .withSuccessHandler(res => {
      // Sembunyikan loading
      if (typeof hideLoading === 'function') hideLoading(); 
      else switchView('view-dashboard');

      if (res.status === 'success') {
        // Isi input modal dengan data dari database
        document.getElementById('set-harian-masuk').value = res.data.jamMasuk || "07:00";
        document.getElementById('set-harian-toleransi').value = res.data.jamToleransi || "15";
        document.getElementById('set-harian-pulang').value = res.data.jamPulang || "15:00";
        
        // Tampilkan Modal
        document.getElementById('modal-setting-harian').classList.add('show');
      } else {
        showToast("Gagal memuat data: " + res.message, "error");
      }
    })
    .getHarianSettings(token); // Memanggil fungsi di Adm_Srv_API.js
}

/**
 * FUNGSI: Simpan Data dari Modal
 */
function simpanJadwalHarian() {
  const token = STORAGE.getItem("sess_t");
  const form = {
    jamMasuk: document.getElementById('set-harian-masuk').value,
    jamToleransi: document.getElementById('set-harian-toleransi').value,
    jamPulang: document.getElementById('set-harian-pulang').value
  };

  showLoading("MENYIMPAN...");

  google.script.run
    .withSuccessHandler(res => {
      showToast(res.message, res.status);
      if(res.status === 'success') {
        // Tutup modal setelah berhasil
        document.getElementById('modal-setting-harian').classList.remove('show');
        // Refresh tabel rekap jika diperlukan (karena status terlambat mungkin berubah)
        loadRekapHarian(); 
      }
    })
    .saveHarianSettings(token, form);
}

  /**
   * PENGATURAN JAM KERJA HARIAN
   */
  function loadHarianSettings() {
    const token = STORAGE.getItem("sess_t");
    showLoading("MENGAMBIL KONFIGURASI...");
    
    google.script.run
      .withSuccessHandler(res => {
        // Matikan loading dengan kembali ke view normal (switchView dashboard mematikan loading overlay jika dikelola Sys_Js_Global)
        // Jika Sys_Js_Global punya fungsi hideLoading(), gunakan itu.
        if (typeof hideLoading === 'function') hideLoading(); 
        else switchView('view-dashboard');

        if (res.status === 'success') {
          document.getElementById('set-harian-masuk').value = res.data.jamMasuk || "";
          document.getElementById('set-harian-toleransi').value = res.data.jamToleransi || "";
          document.getElementById('set-harian-pulang').value = res.data.jamPulang || "";
        } else {
          showToast(res.message, "error");
        }
      })
      .withFailureHandler(err => {
        if (typeof hideLoading === 'function') hideLoading();
        showToast("Gagal mengambil data: " + err.message, "error");
      })
      .getHarianSettings(token);
  }

  function simpanJadwalHarian() {
    const token = STORAGE.getItem("sess_t");
    const form = {
      jamMasuk: document.getElementById('set-harian-masuk').value,
      jamToleransi: document.getElementById('set-harian-toleransi').value,
      jamPulang: document.getElementById('set-harian-pulang').value
    };
    if(!form.jamMasuk || !form.jamToleransi || !form.jamPulang) return showToast("Harap lengkapi waktu!", "error");
    
    showLoading("MENYIMPAN...");
    google.script.run.withSuccessHandler(res => {
      showToast(res.message, res.status);
      if(res.status === 'success') setTimeout(() => navTo('presensi-harian-rekap'), 1500);
    }).saveHarianSettings(token, form);
  }

  // === SIDEBAR & LAYOUT HELPERS ===
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    
    if (window.innerWidth <= 768) {
      sidebar.classList.toggle('open');
      overlay.classList.toggle('show');
    } else {
      sidebar.classList.toggle('closed');
    }
    
    setTimeout(() => {
      if (USER_TABLE_INST) USER_TABLE_INST.columns.adjust().draw();
      if (REKAP_TABLE_INST) REKAP_TABLE_INST.columns.adjust().draw();
    }, 350);
  }

  function loadSettings(token) {
    google.script.run.withSuccessHandler(data => {
      document.getElementById('set-app-name').value = data.appName; 
      document.getElementById('set-app-desc').value = data.appDesc;
      document.getElementById('set-maintenance').checked = data.maintenance; 
      document.querySelector('.sidebar-title').innerText = data.appName;
    }).getSystemSettings(token);
  }

  function logout() {
    STORAGE.removeItem("sess_t");
    STORAGE.removeItem("sess_u");
    window.location.href = google.script.host.origin + google.script.history.location.pathname;
  }
</script>